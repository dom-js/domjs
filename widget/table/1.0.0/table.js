define(["jquery"],function($){var Table=function(ops){$.extend(this,$("<table>"));ops.classname&&this.attr("class",ops.classname);ops.css&&this.css(ops.css);this.valuefield=$("[name="+ops.valuefield+"]");this.rowKeyName=(ops.id||("table_"+parseInt(Math.random()*10000)))+"_row";this.data=[];this.keys=[];$.extend(this,ops);};Table.prototype.set=function(attrname,attrvalue){this[attrname]=attrvalue;};Table.prototype.initHead=function(){if(this._head){this.append(this._head);}else{for(var a in this.layout){}}};Table.prototype.initBody=function(bodystr){var me=this;if(me.data.length>0){$.each(me.data,function(i,item){me.addRow(item);});}else{if(bodystr&&$.trim(bodystr)!=""){$.each(this.unserializeVal(bodystr),function(i,item){if(typeof item=="object"){me.addRow(item);}});}else{for(var i=0;i<this.minrowscount;i++){me.addRow();}}}};Table.prototype.getRowTemplate=function(){};Table.prototype.addRow=function(item){if(this[0].rows.length>this.maxrowscount){return false;}var _row=this._row.clone(true);var _keys={};var _keysStr="";var DefaultKey=parseInt(Math.random()*1000000);if(typeof item=="object"){DefaultKey=item[this.rowKeyName];}$.each(this.keys,function(i,k){if(k!=""){if(typeof item=="object"){_keys[k]=item[k];}else{_keys[k]=DefaultKey;}}_keysStr+=_keys[k];});$.data(_row[0],"keys",_keys);_row.attr("data-key",DefaultKey);$.data(_row[0],"keysstr",_keysStr);_row.find("td[data-type=radio]").each(function(i,td){var _extendname=_keysStr;$(td).find("input").each(function(j,el){if(el.outerHTML){$(el).after((el.outerHTML.replace("__name__",el.name+_extendname)));$(el).remove();}else{el.name=el.name+_extendname;}});});_row.find("input[data-type=delbt]").on("click",{table:this,row:_row},function(e){e.data.table.deleteRow(DefaultKey,true);});this.append(_row);this._updateRow&&this._updateRow(_row,item);this.refresh();};Table.prototype.refresh=function(){$("tr[data-key]",this[0]).each(function(i,tr){$(tr).attr("data-rowindex",i+1);});$("td[data-type=serialno]",this[0]).each(function(i,el){$(el).text(i+1);});};Table.prototype.deleteRow=function(key,flag){if(this[0].rows.length-1<=this.minrowscount){return false;}if(key){if(flag){$("tr[data-key="+key+"]",this[0]).remove();}else{$("[data-rowindex="+key+"]",this[0]).remove();}}this.refresh();};Table.prototype.tablehtml=function(){var _A=$("<div data-type=table>").text(this.serializeVal());return _A.html();};Table.prototype.unserializeVal=function(str){var _reg,_p,_n;var _result=[];$.each(str.split("&"),function(i,p){var item={};_reg=new RegExp("(^.*)=(.*$)");_p=_reg.exec(p);_n=/(^.*)_(\d+$)/.exec(_p[1]);if(!_result[_n[2]-1]){_result[_n[2]-1]={};}_result[_n[2]-1][_n[1]]=decodeURIComponent(_p[2].replace(/\+/g," "));});return _result;};Table.prototype.serializeVal=function(){var _result={};var _data=[];var me=this;$("tr:gt(0)",this[0]).each(function(i,eltr){var n=i+1;_data[i]={};$(eltr).find("td[data-name]").each(function(j,td){td.type="td";var $el=$(td).find("*").is("[data-name]")?$(td).find("[data-name]"):$(td);$el.each(function(i,el){var _name=$.trim($(el).attr("data-name"));var _fieldname=_name+"_"+n;switch(el.type){case"td":_result[_fieldname]=($(el).text());break;case"radio":case"checkbox":if(el.checked){_result[_fieldname]=($(el).val());}break;default:_result[_fieldname]=($(el).val());}_data[n-1][_name]=_result[_fieldname]||"";});});var keyvalues=$.data(eltr,"keys");$.each(me.keys,function(i,k){if(!_result[k+"_"+n]){_result[k+"_"+n]=_data[n-1][k]=keyvalues[k];}});if(!_result[me.rowKeyName+"_"+n]){_result[me.rowKeyName+"_"+n]=_data[n-1][me.rowKeyName]=$(eltr).attr("data-key");}});this.data=_data;return($.param(_result));};Table.Layout=function(ops){};return Table;});