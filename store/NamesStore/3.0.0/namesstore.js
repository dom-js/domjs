define(function(require,exports,module){var Store=require("./RemoteStore");var Memory=require("store/memory");var util=require("base/util");var QueryResults=require("store/util/QueryResults");var model=function(opts){this.options={cachetype:"session",keyname:"localcache_namecache",count:30,type:"P"};$.extend(this.options,opts);opts=this.options;this.store=new Store({count:opts.count});};model.isMatch=function(item){var getMatchString=function(str){return str.replace(/\s/gi,"").toLowerCase();};var abbreviate=getMatchString(item.abbreviate);var originalname=getMatchString(item.originalname);var lastname=getMatchString(item.lastname);var shortname=getMatchString(item.shortname);return abbreviate==originalname||lastname==originalname||shortname==originalname;};model.cacheObject={};model.prototype={options:null,store:null,getLocalData:function(key){try{if(typeof window[this.options.cachetype+"Storage"]=="undefiend"){return[];}var Storage=window[this.options.cachetype+"Storage"];return(new Function("return "+Storage.getItem(key)))()||[];}catch(e){return[];}},setLocalData:function(key,data){try{if(typeof window[this.options.cachetype+"Storage"]=="undefiend"){return false;}var localdata=util.toJSON(data);var Storage=window[this.options.cachetype+"Storage"];Storage.setItem(key,localdata);}catch(e){return false;}},getMemory:function(){var _self=this,key=this.options.keyname;if(!model.cacheObject[key]){var data=this.getLocalData(key);model.cacheObject[key]=new Memory({data:data,idProperty:this.options.idproperty});}return model.cacheObject[key];},saveMemory:function(){var key=this.options.keyname;this.setLocalData(key,this.getMemory().data);},searchCache:function(query,opts){var memory=this.getMemory();return memory.query(this.getCacheQuery(query,opts));},getCacheQuery:function(query,opts){var _self=this;var opts=$.extend({fullmatch:false},this.options,opts);var queryGroup={};var regs=$.map(query,function(q){q=$.trim(q);if(opts.fullmatch){return new RegExp("^"+q+"$","i");}else{if(q==""){return/^.*/;}return new RegExp("^"+q,"i");}});return function(item,i){if(opts.type.toString().toUpperCase()=="P"){if(item.type.toString().toUpperCase()!="PERSON"){return false;}}if(opts.type.toString().toUpperCase()=="G"){if(item.type.toString().toUpperCase()!="GROUP"){return false;}}var flag=false;$.each(regs,function(i,reg){if(reg.test(item.lastname)||reg.test(item.shortname)){flag=true;return false;}});return flag;};},load:function(){return $.when([]);},cache:function(){return this.load();},query:function(query,opts){var query=query.toString().split(/[,;]/gi);var _self=this;opts=$.extend({},this.options,opts);var res=this.searchCache(query,opts).pipe(function(data){if(data.length>=_self.options.count){return data;}if(query[0]==""){return data;}var cacheKey="remotecache_"+query.toString();if(!model.cacheObject[cacheKey]){model.cacheObject[cacheKey]=_self.store.query(query.join(","),opts).pipe(function(data){var memory=_self.getMemory();$.each(data,function(i,item){memory.put(item);});_self.saveMemory();return data;});}return model.cacheObject[cacheKey].pipe(function(){return _self.searchCache(query,opts);});},function(e){return e;});return QueryResults(res);}};return model;});