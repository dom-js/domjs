define(["jquery","./readviewentriesadapter"],function($,adapter){var parseError=function(data){switch(data.status){case 200:var action=data.responseText.match(/\saction="(\/names\.nsf\?login)"\s/i);if(!!action){window.open("/names.nsf?login&RedirectTo="+window.top.location.href,"_top");}break;case 400:alert($(data.responseText).text()+data.status+":"+data.statusText+"\n"+this.url);break;case 404:alert($(data.responseText).text()+"\n"+data.status+":"+data.statusText+"\n"+this.url);break;case 500:alert("服务器异常错误\n"+data.status+":"+data.statusText+"\n"+this.url);break;default:alert("未知错误\n"+data.status+":"+data.statusText+"\n"+this.url);}return[{label:"Error"}];};var ajaxResult={};return function(query,options,callback){var opts={},params="start count expand expandview  collapse collapseview endview keytype navigatereverse preformat restricttocategory resortdescendingpn resortascendingpn startkey untilkey sort".split(" ");$.each(options,function(key,val){if(typeof val!="undefined"&&$.inArray(key.toLowerCase(),params)>-1){if(key=="sort"){if(val.descending){if(val.name){opts.resortdescendingpn=val.name;}else{opts.resortdescending=val.column||1;}}else{if(val.ascending){if(val.name){opts.resortascendingpn=val.name;}else{opts.resortascending=val.column||1;}}}}else{if(key=="restricttocategory"){if(val!=""&&val!="*"){opts[key]=val;}}else{opts[key]=val;}}}});var _l=window.location;var _db="";try{_db=_l.pathname.match(/[^(?)]*.nsf/)[0];}catch(e){}if(!options||!options.view){new Error("需要指定视图地址");return false;}var options=$.extend({protocol:"",host:_l.host,db:_db,view:""},options);var _q=$.extend({expand:0,start:options.start||1,count:options.count||30},opts,query);_q.start=_q.start<1?1:_q.start;_q.isExpand=(_q.expand-0)!=0*1;if(_q.isExpand){_q.start=_q.expand+"."+_q.start;}var _callback=function(data){data=adapter(data,_q);if(callback){callback(data);}return data;};var deferred=new $.Deferred();if(options.host!=_l.host||options.inotesquery){var _url=options.protocol+"//"+options.host+"/iNotes/forms8.nsf/iNotes/Proxy/?OpenDocument";_url+="&Form=s_JSONPViewList&"+options.view;_url+="&PresetFields=DBName;"+options.db;_url+=",FolderName;"+options.view;_url+=",UnreadOnly;"+(options.unreadonly||0);var modulename=options.view+"/"+(new Date()).getTime()+"/"+Math.random().toString().substr(2);var _q=$.extend(_q,{module:modulename});try{$.ajax({url:_url,dataType:"script",data:_q}).pipe(function(){require([modulename],function(module){deferred.resolve(_callback(module));},function(err){deferred.reject(err);});},function(err){deferred.reject(err);});}catch(err){deferred.reject(err);}}else{var _url=options.protocol+"//"+options.host+options.db+"/"+options.view+"?readviewentries&outputformat=json&"+(new Date()).getTime();$.get(_url,_q).pipe(function(data){deferred.resolve(_callback(data));},function(err){deferred.reject(err);});}return deferred;};});