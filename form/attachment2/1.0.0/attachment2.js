define(["jquery","base/objectj","appinfo","docinfo","i18n!nls/form"],function($,obj,appinfo,docinfo,i18n){var base64=(function($){var _PADCHAR="=",_ALPHA="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",_VERSION="1.0";function _getbyte64(s,i){var idx=_ALPHA.indexOf(s.charAt(i));if(idx===-1){throw"Cannot decode base64";}return idx;}function _decode(s){var pads=0,i,b10,imax=s.length,x=[];s=String(s);if(imax===0){return s;}if(imax%4!==0){throw"Cannot decode base64";}if(s.charAt(imax-1)===_PADCHAR){pads=1;if(s.charAt(imax-2)===_PADCHAR){pads=2;}imax-=4;}for(i=0;i<imax;i+=4){b10=(_getbyte64(s,i)<<18)|(_getbyte64(s,i+1)<<12)|(_getbyte64(s,i+2)<<6)|_getbyte64(s,i+3);x.push(String.fromCharCode(b10>>16,(b10>>8)&255,b10&255));}switch(pads){case 1:b10=(_getbyte64(s,i)<<18)|(_getbyte64(s,i+1)<<12)|(_getbyte64(s,i+2)<<6);x.push(String.fromCharCode(b10>>16,(b10>>8)&255));break;case 2:b10=(_getbyte64(s,i)<<18)|(_getbyte64(s,i+1)<<12);x.push(String.fromCharCode(b10>>16));break;}return x.join("");}function _getbyte(s,i){var x=s.charCodeAt(i);if(x>255){throw"INVALID_CHARACTER_ERR: DOM Exception 5";}return x;}function _encode(s){if(arguments.length!==1){throw"SyntaxError: exactly one argument required";}s=String(s);var i,b10,x=[],imax=s.length-s.length%3;if(s.length===0){return s;}for(i=0;i<imax;i+=3){b10=(_getbyte(s,i)<<16)|(_getbyte(s,i+1)<<8)|_getbyte(s,i+2);x.push(_ALPHA.charAt(b10>>18));x.push(_ALPHA.charAt((b10>>12)&63));x.push(_ALPHA.charAt((b10>>6)&63));x.push(_ALPHA.charAt(b10&63));}switch(s.length-imax){case 1:b10=_getbyte(s,i)<<16;x.push(_ALPHA.charAt(b10>>18)+_ALPHA.charAt((b10>>12)&63)+_PADCHAR+_PADCHAR);break;case 2:b10=(_getbyte(s,i)<<16)|(_getbyte(s,i+1)<<8);x.push(_ALPHA.charAt(b10>>18)+_ALPHA.charAt((b10>>12)&63)+_ALPHA.charAt((b10>>6)&63)+_PADCHAR);break;}return x.join("");}return{decode:_decode,encode:_encode,VERSION:_VERSION};}($));var attachment2=obj.sub();function getNiceFileSize(bitnum){var _K=1024;var _M=_K*1024;if(bitnum<_M){if(bitnum<_K){return bitnum+"B";}else{return Math.ceil(bitnum/_K)+"K";}}else{return Math.ceil(100*bitnum/_M)/100+"M";}}attachment2.fn.extend({main:function(selector,context){if(!this.options.agentpath){alert("需要管理员配置文件代理路径");}if(this.data("this")){return this.data("this");}this.data("this",this);$.extend(this.options,context);var othis=this[0];this.name=this.options.name||this.attr("name");this.panel=attachment2.createdPanel(this.name);this.before(this.panel).hide();if(this.options.editable){var _self=this;this.button=attachment2.createdButtonUpload();this.button.bind("click",function(){_self.selectFile.call(_self);});this.panel.append(this.button);}this.listpanel=attachment2.createdListPanel();this.panel.append(this.listpanel);this.getItem();return this;},validate:function(){return this.val()!="";},options:{isauthor:docinfo.isauthorcurr,name:undefined,editable:docinfo.isauthorcurr&&docinfo.isdocbeingedited,agentpath:appinfo.filesagentpath,unid:docinfo.unid,unid34:docinfo.unid34,username:appinfo.username,appname:appinfo.appname,flashdoc:appinfo.flashdoc||false,writelog:false,downable:true},panel:null,button:null,listpanel:null,name:"",selectFile:function(){attachment2.selectFile.call(this);},getItem:function(){var url=this.options.agentpath+"/getfileList.action?";var callback="attachment/"+this.name+"/"+(new Date()).getTime()+"/"+Math.random().toString().substr(2);url+="&callback="+callback;url+="&wf_unid="+this.options.unid34;url+="&position="+this.name;var _self=this;try{$.getScript(url,function(){require([callback],function(data){_self.listpanel.empty();$.each(data,function(i,item){var opts={type:item.FILE_REALNAME.match(/\.{1}([^\.]*$)/)[1],url:item.FILE_URL,text:item.FILE_REALNAME,size:getNiceFileSize(item.FILE_SIZE),unid:item.FILE_ID,flashdoc:item.FILE_FLASHDOC||false};_self.addItem(opts);});_self.computervalue();});}).fail(function(){});}catch(e){}},computervalue:function(){this.val(this.listpanel.find("span").length>0?"<div data-type='attachment2' data-name='"+this.name+"'>":"");},addItem:function(opts,panel){var _self=this;var domRow=$("<span></span>");opts.key=_self.getKey(opts.unid);if(this.options.editable){var delDom=attachment2.createdButtonDelete().attr("dataDocLink",opts.url).css("cursor","pointer").bind("click",function(){_self.delItem(opts.unid,opts.key,this);});domRow.append(delDom);domRow.append("&nbsp;");}var domLink=$("<a></a>");if(opts.type){var domType=$("<img>").attr("src","/HikDefaultSytle/images/"+opts.type+".gif");domRow.append(domType);domType.error(function(){domType.attr("src","/HikDefaultSytle/images/unkown.gif").attr("width",13).attr("height",16);});}domRow.append("&nbsp;");if(opts.url){domLink.attr("target","attachment");domLink.css({cursor:"pointer"});if(_self.options.downable){var url=window.location.href.match(/^[^\?]*/)+"?opendocument&fileId="+opts.unid+"&form=fmAttachment2Download&key="+opts.key;url+="&_l="+_self.options.writelog;url=url.replace(/(\.nsf\/)[^\/]*(\/)/,"$1(all)$2");domLink.attr("href",url);}else{}if(opts.text){domLink.html(opts.text);}else{domLink.html(opts.url);}if(this.options.target){domLink.attr("target",this.options.target);}else{var iframe=$("iframe[name=attachment]");if(iframe.length==0){iframe=$("<iframe  style='display:none' name=attachment></iframe>");$("body").append(iframe);}}}else{if(opts.text){domLink.html(opts.text);}}domRow.append(domLink);if(opts.flashdoc){var domPreview=$("<span style='cursor: pointer; padding:1px;margin:1px;margin-left: 3px; margin-right: 3px;border:1px dotted #666;'>"+i18n.Preview+"</span>");domPreview.on("click",function(){_self.preview(opts.unid,opts.key,opts);});domRow.append(domPreview);}domRow.append("("+opts.size+")");domRow.append("<br>");this.listpanel.append(domRow);},getKey:function(unid){var key="";var j=this.name.length;var m,n;for(m=0;m<32;m++){n=m+j;n>31?n-=31:n;key1=this.options.unid34.substr(n+2,1),key2=unid.substr(31-n,1);key+=key1+key2;}return base64.encode(key);},delItem:function(fileid,key,el){var _self=this;var url=this.options.agentpath+"/deletefile.action?fileId="+fileid;var callback="attachment/delete/"+fileid+"/"+(new Date()).getTime()+"/"+Math.random().toString().substr(2);url+="&callback="+callback;url+="&key="+key;var _self=this;require(["widget/jbox"],function(jBox){jBox.tip(i18n.deleting,"waiting");$.getScript(url,function(data){require([callback],function(data){jBox.closeTip();if(el){$(el).parent().remove();_self.computervalue();}else{_self.getItem();}});});});},preview:function(fileid,key,item){require(["widget/jbox"],function(jbox){var buttons={},width,height;width=$("body").width()*0.9;height=$(window).height()-60;buttons[i18n.Close]="close";jbox("iframe://baidu.com",{draggable:false,top:30,width:width,height:height,title:i18n.Preview+":"+item.text,buttons:buttons});});},getButton:function(id){$("div[dataID='"+id+"'] [dataType='button']");return $("div[dataID='"+id+"'] [dataType='button']");}});attachment2.extend({created:function(selector,context){return attachment2(selector,context);},createdPanel:function(position){return $("<div   data-position='"+position+"'></div>");},createdListPanel:function(){return $("<div ></div>");},createdButtonUpload:function(){var bt=$("<a  ></a>");$('<img  style="BACKGROUND-IMAGE: url(/iNotes/Forms8.nsf/commonactionicons.gif?OpenFileResource&MX&TS=20080904T004937,78Z); BACKGROUND-POSITION: -80px 0px">').attr("src","/iNotes/Forms8.nsf/transparent.gif").attr("title",i18n.attachment).attr("alt",i18n.attachment).css("height",16).css("width",16).appendTo(bt);bt.css("cursor","pointer").append(i18n.attachmentselect);return bt;},createdButtonDelete:function(){return $("<img dataType='btDel'  style=\"BACKGROUND-IMAGE: url(/iNotes/Forms8.nsf/commonactionicons.gif?OpenFileResource&MX&TS=20080904T004937,78Z); BACKGROUND-POSITION: -48px 0px\">").attr("src","/iNotes/Forms8.nsf/transparent.gif").css("height",16).css("width",16);},selectFile:function(){var _self=this;require(["upload/upload"],function(upload){var up=upload(_self,_self.options);up.showDialog();});}});return attachment2;});